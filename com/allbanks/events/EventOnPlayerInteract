package com.allbanks.events;

import java.io.File;
import java.io.IOException;

import net.milkbowl.vault.economy.Economy;

import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.block.Sign;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.plugin.RegisteredServiceProvider;

import com.github.drako900.BankPlayer;
import com.github.drako900.MainAllBank;
import com.github.drako900.MainLeaderboard;

public class EventOnPlayerInteract {
	

	   //ECONOMY
		public static Economy econ = null;
	   public boolean setupEconomy(){
	       RegisteredServiceProvider<Economy> rsp = plugin.getServer().getServicesManager().getRegistration(Economy.class);
	       if (rsp == null) {
	           return false;
	       }
	       econ = rsp.getProvider();
	       return econ != null;
	       }
	
	MainAllBank plugin;
    public EventOnPlayerInteract(MainAllBank MainAllBank) {
        this.plugin = MainAllBank;
    }
	
	@SuppressWarnings("unused")
	public void OnPlayerInteract(PlayerInteractEvent event){
		
		Player player = event.getPlayer();
		
		
		
		Block clickedBlock = event.getClickedBlock();
		
		
		
		if(clickedBlock==null){
			return;
		}
		
		
			Block signBlock = clickedBlock;
    		if (signBlock == null) return;
    	
    		if (signBlock.getTypeId() != 68) return;
			Sign sign = (Sign)signBlock.getState();
			Action action = event.getAction();
		    
			//AllBanks 1.6.2
			if (player.getItemInHand() != null && player.getItemInHand().getType().equals(Material.STICK) && action == Action.LEFT_CLICK_BLOCK){

				
				//guardamos
				
					if(plugin.leaderboard.containsValue(player.getName())){
						
					}else{
						plugin.leaderboard.put(new MainLeaderboard(player), player.getName());
					}
					
					MainLeaderboard mainleaderboard = plugin.leaderboardforplayer(player);
					if(mainleaderboard == null){
						event.setCancelled(true);
						return;
					}else{
						if(mainleaderboard.getSignNumber()==1){
							player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"Select a second sign.");
							//already first sign set
							if(mainleaderboard.getFirstSign()==null){
								
								sign.setLine(0, ChatColor.WHITE+"[AllBanks]");
								sign.setLine(1, ChatColor.WHITE+"[Lottery]");
								sign.setLine(2, ChatColor.WHITE+"[Leaderboard]");
								sign.setLine(3, ChatColor.WHITE+"First sign");
								sign.update();
								mainleaderboard.setFirstSign(sign);
								mainleaderboard.setSignNumber(2);
							}else{
								Sign lastsign = mainleaderboard.getFirstSign();
								lastsign.setLine(0, "");
								lastsign.setLine(1, "");
								lastsign.setLine(2, "");
								lastsign.setLine(3, "");
								lastsign.update();
								
								sign.setLine(0, ChatColor.WHITE+"[AllBanks]");
								sign.setLine(1, ChatColor.WHITE+"[Lottery]");
								sign.setLine(2, ChatColor.WHITE+"[Leaderboard]");
								sign.setLine(3, ChatColor.WHITE+"First sign ");
								sign.update();
								
								mainleaderboard.setFirstSign(sign);
								mainleaderboard.setSignNumber(2);
							}
						}else{
							player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"Use command "+ChatColor.DARK_AQUA+"/allbanks leaderboard new"+ChatColor.GRAY+" to finish, otherwise, select a first sign again.");
							//already first sign set
							if(mainleaderboard.getSecondSign()==null){
								
								sign.setLine(0, ChatColor.WHITE+"[AllBanks]");
								sign.setLine(1, ChatColor.WHITE+"[Lottery]");
								sign.setLine(2, ChatColor.WHITE+"[Leaderboard]");
								sign.setLine(3, ChatColor.WHITE+"Second sign");
								sign.update();
								mainleaderboard.setSecondSign(sign);
								mainleaderboard.setSignNumber(1);
							}else{
								Sign lastsign = mainleaderboard.getSecondSign();
								lastsign.setLine(0, "");
								lastsign.setLine(1, "");
								lastsign.setLine(2, "");
								lastsign.setLine(3, "");
								lastsign.update();
								
								
								sign.setLine(0, ChatColor.WHITE+"[AllBanks]");
								sign.setLine(1, ChatColor.WHITE+"[Lottery]");
								sign.setLine(2, ChatColor.WHITE+"[Leaderboard]");
								sign.setLine(3, ChatColor.WHITE+"Second sign ");
								sign.update();
								mainleaderboard.setSecondSign(sign);
								mainleaderboard.setSignNumber(1);
							}
						}
					}
				
				
				event.setCancelled(true);
				return;
			}
			
			if (!sign.getLine(0).equals(ChatColor.AQUA + "Bank -> Loan")&&!sign.getLine(0).equals(ChatColor.GREEN + "Bank -> XP")&&!sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Money")&&!sign.getLine(0).equals(ChatColor.YELLOW + "Bank Esmerald")&&!sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Time")) return;
			if(action == Action.RIGHT_CLICK_BLOCK){}else{ 
				//AllBanks 1.6.2 - Cambiamos el letrero al golpear con un item en específico
				if (player.getItemInHand() != null && player.getItemInHand().getType().equals(Material.BONE)) {
				    // Code         
					if(!player.hasPermission("a.item.changebank")) return;
					
					//switch
					int thisbank = 0;
					if(sign.getLine(0).equals(ChatColor.AQUA + "Bank -> Loan")) thisbank = 1;
					if(sign.getLine(0).equals(ChatColor.GREEN + "Bank -> XP")) thisbank = 2;
					if(sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Money")) thisbank = 3;
					if(sign.getLine(0).equals(ChatColor.YELLOW + "Bank Esmerald")) thisbank = 4;
					if(sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Time")) thisbank = 5;
					
					int nextbank = thisbank + 1;
					if(nextbank==6) nextbank = 1;
					
					switch(nextbank){
					
					case 1:
						sign.setLine(0, ChatColor.AQUA + "Bank -> Loan");
						sign.setLine(1, ChatColor.AQUA+"~~~~~~~~~~~~");
						sign.setLine(2, "" + plugin.langCF("signwelcome"));
						sign.setLine(3, "");
						sign.update(true);
						player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"This bank changed to BankLoan.");
						break;
					case 2:
						sign.setLine(0, ChatColor.GREEN + "Bank -> XP");
						sign.setLine(1, ChatColor.GREEN+"~~~~~~~~~~~~");
						sign.setLine(2, "" + plugin.langCF("signwelcome"));
						sign.setLine(3, "");
						sign.update(true);
						player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"This bank changed to BankXP.");
						break;
					case 3:
						sign.setLine(0, ChatColor.WHITE + "Bank -> Money");
						sign.setLine(1, ChatColor.WHITE+"~~~~~~~~~~~~");
						sign.setLine(2, "" + plugin.langCF("signwelcome"));
						sign.setLine(3, "");
						sign.update(true);
						player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"This bank changed to BankMoney.");
						break;
					case 4:
						sign.setLine(0, ChatColor.YELLOW + "Bank Esmerald");
						sign.setLine(1, ChatColor.YELLOW+"~~~~~~~~~~~~");
						sign.setLine(2, "" + plugin.langCF("signwelcome"));
						sign.setLine(3, "");
						player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"This bank changed to BankEsmerald.");
						sign.update(true);
						break;
					case 5:
						sign.setLine(0, ChatColor.WHITE + "Bank -> Time");
						sign.setLine(1, ChatColor.WHITE+"~~~~~~~~~~~~");
						sign.setLine(2, "" + plugin.langCF("signwelcome"));
						sign.setLine(3, "");
						player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"This bank changed to BankTime.");
						sign.update(true);
						break;
						
					}
					event.setCancelled(true);
					return;
					
				}else if (player.getItemInHand() != null && player.getItemInHand().getType().equals(Material.FLINT)){
					if(sign.getLine(2).equals(ChatColor.WHITE+"Bank")&&sign.getLine(3).equals(ChatColor.WHITE+"Closed")){
						sign.setLine(2, "" + plugin.langCF("signwelcome"));
						sign.setLine(3, "");
						sign.update();
						event.setCancelled(true);
						player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"Bank Opened.");
						return;
					}else{
						sign.setLine(2, ChatColor.WHITE+"Bank");
						sign.setLine(3, ChatColor.WHITE+"Closed");
						sign.update();
						event.setCancelled(true);
						player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"Bank Closed.");
						return;
					}
				}
				
				return;
				
			}
		
		
			event.setCancelled(true);
			
			//AllBanks 1.6.2 - Bank Closed
				if(sign.getLine(2).equals(ChatColor.WHITE+"Bank")&&sign.getLine(3).equals(ChatColor.WHITE+"Closed")){
					player.sendMessage(ChatColor.GOLD+"[AllBanks] "+ChatColor.GRAY+"This bank is closed.");
					return;
				}
			
			
			if (player.hasPermission("ebank.admin") && player.isSneaking()) {
				return;
			}
			
			
			BankPlayer bPlayer = null;
			
			//DETECTAMOS SI TIENE PERMISOS DE USAR
			boolean cant_use = false;
			
			//MODO "SIN PLUGIN DE PERMISOS" ¿Activado?
			if(plugin.getConfig().getBoolean("Plugin.off-permisions")==true){
				cant_use = true;
			}
				
			boolean disabled_bank = false;
			int bank_id = 0;
			
    		if(player.hasPermission("allbanks.sign.use")){
    			cant_use = true;
    			
    			if(plugin.getConfig().getBoolean("BankLoan.enable-bank")==false && sign.getLine(0).equals(ChatColor.AQUA + "Bank -> Loan")){
    				disabled_bank = true;
    				bank_id = 1;
    			}
    			
    			if(plugin.getConfig().getBoolean("BankMoney.enable-bank")==false && sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Money")){
    				disabled_bank = true;
    				bank_id = 2;
    			}
    			
    			if(plugin.getConfig().getBoolean("BankXP.enable-bank")==false && sign.getLine(0).equals(ChatColor.GREEN + "Bank -> XP")){
    				disabled_bank = true;
    				bank_id = 3;
    			}
    			
    			if(plugin.getConfig().getBoolean("BankEsmerald.enable-bank")==false && sign.getLine(0).equals(ChatColor.YELLOW + "Bank Esmerald")){
    				disabled_bank = true;
    				bank_id = 4;
    			}
    			
    			if(plugin.getConfig().getBoolean("BankTime.enable-bank")==false && sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Time")){
    				disabled_bank = true;
    				bank_id = 5;
    			}
    			
    		}else if(player.hasPermission("a.bankloan.sign.use") && sign.getLine(0).equals(ChatColor.AQUA + "Bank -> Loan")){
    			cant_use = true;
    			
    			if(plugin.getConfig().getBoolean("BankLoan.enable-bank")==false){
    				disabled_bank = true;
    				bank_id = 1;
    			}
    			
    		}else if(player.hasPermission("a.bankmoney.sign.use") && sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Money")){
    			cant_use = true;
    			
    			if(plugin.getConfig().getBoolean("BankMoney.enable-bank")==false){
    				disabled_bank = true;
    				bank_id = 2;
    			}
    			
    		}else if(player.hasPermission("a.bankxp.sign.use") && sign.getLine(0).equals(ChatColor.GREEN + "Bank -> XP")){
    			cant_use = true;
    			
    			if(plugin.getConfig().getBoolean("BankXP.enable-bank")==false){
    				disabled_bank = true;
    				bank_id = 3;
    			}
    			
    		}else if(player.hasPermission("a.bankesmerald.sign.use") && sign.getLine(0).equals(ChatColor.YELLOW + "Bank Esmerald")){
    			cant_use = true;
    			
    			if(plugin.getConfig().getBoolean("BankEsmerald.enable-bank")==false){
    				disabled_bank = true;
    				bank_id = 4;
    			}
    			
    		}else if(player.hasPermission("a.banktime.sign.use") && sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Time")){
    			cant_use = true;
    			
    			if(plugin.getConfig().getBoolean("BankTime.enable-bank")==false){
    				disabled_bank = true;
    				bank_id = 5;
    			}
    		}
    			
    		
    		
    		if(cant_use == false){
    			if(event.getClickedBlock().getType()==Material.WALL_SIGN||event.getClickedBlock().getType()==Material.SIGN_POST){
    				Sign sign1 = (Sign) event.getClickedBlock().getState();
    				String[] sign2 = sign1.getLines();
    				
    				if(sign2[0].equals(ChatColor.AQUA + "Bank -> Loan")||sign2[0].equals(ChatColor.WHITE + "Bank -> Money")||sign2[0].equals(ChatColor.GREEN + "Bank -> XP")||sign2[0].equals(ChatColor.YELLOW + "Bank Esmerald")||sign2[0].equals(ChatColor.WHITE + "Bank -> Time")){
    					player.sendMessage(ChatColor.BLUE+"[AllBanks] "+plugin.langCF("nopermusechest"));
    					event.setCancelled(true);
    					return;
    				}
    			}
    		}
    		
    		if(plugin.getConfig().getBoolean("Plugin.disable-all-banks")){
    			if(sign.getLine(0).equals(ChatColor.AQUA + "Bank -> Loan")||sign.getLine(0).equals(ChatColor.GREEN + "Bank -> XP")||sign.getLine(0).equals(ChatColor.YELLOW + "Bank Esmerald")||sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Money")){
    				player.sendMessage(ChatColor.BLUE+"[AllBanks] "+plugin.langCF("cant-use-all-banks-disabled"));
    				return;
    			}
    		}
    		
    		if(disabled_bank == true){
    			if(bank_id == 1){
    				//BankLoan
            		player.sendMessage(ChatColor.BLUE+"[AllBanks]"+ChatColor.RED+"You can't use this bank! "+ChatColor.BOLD+"BankLoan"+ChatColor.RED+" disabled");
            		return;
    			}if(bank_id == 2){
    				//BankMoney
            		player.sendMessage(ChatColor.BLUE+"[AllBanks]"+ChatColor.RED+"You can't use this bank! "+ChatColor.BOLD+"BankMoney"+ChatColor.RED+" disabled");
            		return;
    			}if(bank_id == 3){
    				//BankXP
            		player.sendMessage(ChatColor.BLUE+"[AllBanks]"+ChatColor.RED+"You can't use this bank! "+ChatColor.BOLD+"BankXP"+ChatColor.RED+" disabled");
            		return;
    			}if(bank_id == 4){
    				//BankEsmerald
            		player.sendMessage(ChatColor.BLUE+"[AllBanks]"+ChatColor.RED+"You can't use this bank! "+ChatColor.BOLD+"BankEsmerald"+ChatColor.RED+" disabled");
            		return;
    			}if(bank_id == 5){
    				//BankEsmerald
            		player.sendMessage(ChatColor.BLUE+"[AllBanks]"+ChatColor.RED+"You can't use this bank! "+ChatColor.BOLD+"BankTime"+ChatColor.RED+" disabled");
            		return;
    			}else{
    				player.sendMessage(ChatColor.BLUE+"[AllBanks]"+ChatColor.RED+"You can't use this bank! ");
    				return;
    			}
    		}
			
			//BANK LOAN - CODE
		if(sign.getLine(0).equals(ChatColor.AQUA + "Bank -> Loan")){
			if (plugin.isOpenBank(sign)) {
				if (plugin.bankPlayerForPlayer(player) != null) {
		    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("signalreadyopen"));
					return;
				}
			
				bPlayer = new BankPlayer(player, sign);

				player.sendMessage(ChatColor.BLUE + "[AllBanks] " + ChatColor.YELLOW + "-----------------------");
				player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("welcomechat1") + player.getName()+"!");
	    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("dispmoneychat1") + ": " + econ.format(econ.getBalance(player.getName())));
	    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + ChatColor.YELLOW + "-----------------------");
	    	
	    		plugin.bankUsers.put(bPlayer, sign);
	    		plugin.moveCheck.put(player.getName(), signBlock.getLocation());
				File fileplayer = new File(plugin.getDataFolder()+File.separator+"pdata"+File.separator+player.getName()+".yml");
				YamlConfiguration FPlayer = YamlConfiguration.loadConfiguration(fileplayer);

				FPlayer.set("info.use-last-bank", 2);
				try {
					FPlayer.save(fileplayer);
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			} else {
				BankPlayer _bPlayer = plugin.bankPlayerForSign(sign);
				if (_bPlayer.getPlayer().equals(player)) bPlayer = _bPlayer;
			}
		
			if (bPlayer != null) {

				plugin.switchBankStateBankLoan(bPlayer);
				
			} else {
	    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("atmisused"));

			}
			
		}
		
			//BANK XP - CODE
		if(sign.getLine(0).equals(ChatColor.GREEN + "Bank -> XP")){
			if (plugin.isOpenBank(sign)) {
				if (plugin.bankPlayerForPlayer(player) != null) {
		    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("signalreadyopen"));
					return;
				}
			
				bPlayer = new BankPlayer(player, sign);
	    	
				plugin.bankUsers.put(bPlayer, sign);
				plugin.moveCheck.put(player.getName(), signBlock.getLocation());
	    		
				File fileplayer = new File(plugin.getDataFolder()+File.separator+"pdata"+File.separator+player.getName()+".yml");
				YamlConfiguration FPlayer = YamlConfiguration.loadConfiguration(fileplayer);

				FPlayer.set("info.use-last-bank", 1);
				
				//convert last save in xp
				int xpplayer_save = FPlayer.getInt("bankxp.xp-save");
				int xpplayer_save2 = FPlayer.getInt("bankxp.xp-save-exp");
				
	        	FPlayer.set("bankxp.xp-save-exp",plugin.convertLevelToExp(xpplayer_save)+xpplayer_save2);
	        	FPlayer.set("bankxp.xp-save",0);
	        	
				try {
					FPlayer.save(fileplayer);
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			} else {
				BankPlayer _bPlayer = plugin.bankPlayerForSign(sign);
				if (_bPlayer.getPlayer().equals(player)) bPlayer = _bPlayer;
			}
		
			if (bPlayer != null) {

				plugin.switchBankStateBankXP(bPlayer);
				
			} else {
	    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("atmisused"));

			}	
		}
		
		//BANK ESMERALD - CODE
	if(sign.getLine(0).equals(ChatColor.YELLOW + "Bank Esmerald")){
		if (plugin.isOpenBank(sign)) {
			if (plugin.bankPlayerForPlayer(player) != null) {
	    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("signalreadyopen"));
				return;
			}
		
			bPlayer = new BankPlayer(player, sign);
    	
			plugin.bankUsers.put(bPlayer, sign);
			plugin.moveCheck.put(player.getName(), signBlock.getLocation());
    		
			File fileplayer = new File(plugin.getDataFolder()+File.separator+"pdata"+File.separator+player.getName()+".yml");
			YamlConfiguration FPlayer = YamlConfiguration.loadConfiguration(fileplayer);

			FPlayer.set("info.use-last-bank", 4);
			try {
				FPlayer.save(fileplayer);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		} else {
			BankPlayer _bPlayer = plugin.bankPlayerForSign(sign);
			if (_bPlayer.getPlayer().equals(player)) bPlayer = _bPlayer;
		}
	
		if (bPlayer != null) {

			plugin.switchBankStateBankEsmerald(bPlayer);
			
		} else {
    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("atmisused"));

		}	
	}
		
		//BANK MONEY - CODE
	if(sign.getLine(0).equals(ChatColor.WHITE + "Bank -> Money")){
		if (plugin.isOpenBank(sign)) {
			if (plugin.bankPlayerForPlayer(player) != null) {
	    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("signalreadyopen"));
				return;
			}
		
			bPlayer = new BankPlayer(player, sign);
    	
			plugin.bankUsers.put(bPlayer, sign);
			plugin.moveCheck.put(player.getName(), signBlock.getLocation());
    		
			File fileplayer = new File(plugin.getDataFolder()+File.separator+"pdata"+File.separator+player.getName()+".yml");
			YamlConfiguration FPlayer = YamlConfiguration.loadConfiguration(fileplayer);

			FPlayer.set("info.use-last-bank", 3);
			try {
				FPlayer.save(fileplayer);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		} else {
			BankPlayer _bPlayer = plugin.bankPlayerForSign(sign);
			if (_bPlayer.getPlayer().equals(player)) bPlayer = _bPlayer;
		}
	
		if (bPlayer != null) {

			plugin.switchBankStateBankMoney(bPlayer);
			
		} else {
    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("atmisused"));

		}	
	}
	
	//BANK TIME CODE
	if(sign.getLine(0).equals(ChatColor.WHITE+"Bank -> Time")){
		if (plugin.isOpenBank(sign)) {
			if (plugin.bankPlayerForPlayer(player) != null) {
	    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("signalreadyopen"));
				return;
			}
		
			bPlayer = new BankPlayer(player, sign);
    	
			plugin.bankUsers.put(bPlayer, sign);
			plugin.moveCheck.put(player.getName(), signBlock.getLocation());
    		
			File fileplayer = new File(plugin.getDataFolder()+File.separator+"pdata"+File.separator+player.getName()+".yml");
			YamlConfiguration FPlayer = YamlConfiguration.loadConfiguration(fileplayer);

			FPlayer.set("info.use-last-bank", 5);
			try {
				FPlayer.save(fileplayer);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		} else {
			BankPlayer _bPlayer = plugin.bankPlayerForSign(sign);
			if (_bPlayer.getPlayer().equals(player)) bPlayer = _bPlayer;
		}
	
		if (bPlayer != null) {

			plugin.switchBankStateBankTime(bPlayer);
			
		} else {
    		player.sendMessage(ChatColor.BLUE + "[AllBanks] " + plugin.langCF("atmisused"));

		}	
	}
	
	}
}
